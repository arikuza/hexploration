# Руководство по системе карты и колонизации (HexMapManager)

## Обзор

`HexMapManager` - это система управления гексагональной картой игры, включающая генерацию карты, управление типами секторов, колонизацию систем и систему влияния (threat).

## Архитектура

### Класс HexMapManager

`HexMapManager` управляет:
- Генерацией гексагональной карты
- Типами космических секторов
- Системой влияния (threat) от станций и колоний
- Колонизацией систем игроками
- Развитием колоний
- Деградацией колоний со временем

## Генерация карты

### Метод `generateMap()`

Создает новую карту с заданным радиусом.

**Процесс генерации:**
1. Создает все гексы в радиусе от центра (0, 0)
2. Определяет NPC станции с их базовым уровнем threat
3. Для каждого гекса вычисляет threat на основе расстояния до станций
4. Генерирует тип системы (95% планетарные, 5% пустые)
5. Случайно добавляет ресурсы (30% вероятность)

**NPC станции:**
- Центральная станция: `[0, 0]` с threat = 1.0
- Периферийная станция: `[0, -7]` с threat = 0.5

### Типы систем

- **PLANETARY** (95%) - планетарная система
- **EMPTY** (5%) - пустое космическое пространство

## Система влияния (Threat)

### Уровни threat

Threat определяет уровень безопасности/влияния в гексе:

- **1.0** - максимальная безопасность (центр NPC станции)
- **0.5 - 1.0** - безопасная зона под защитой станции
- **0.0 - 0.5** - нейтральная зона
- **-0.5 - 0.0** - опасная зона
- **-1.0 - -0.5** - очень опасная зона
- **-2.0** - неизвестная зона (далеко от всех станций)

### Вычисление threat

#### Для NPC станций
```typescript
calculateThreatFromStation(distance, stationThreat)
```

**Параметры:**
- `distance` - расстояние до станции в гексах
- `stationThreat` - базовый уровень threat станции (0.5 или 1.0)

**Формула:**
- На расстоянии 0: возвращает `stationThreat`
- В зоне влияния (0 < distance <= maxInfluence):
  - Для threat=1.0: maxInfluence = 10 гексов
  - Для threat=0.5: maxInfluence = 6 гексов
  - Линейное уменьшение от `stationThreat` до `-1.0`
- В зоне неизвестности (maxInfluence < distance <= unknownZone):
  - unknownZone = maxInfluence + 15
  - Линейное уменьшение от `-1.0` до `-2.0`
- За пределами: возвращает `-2.0`

#### Для колоний игроков
Использует ту же формулу, но:
- Базовый threat колонии: 0.5 (при создании)
- maxInfluence зависит от уровня развития колонии:
  - threat >= 0.99: maxInfluence = 10
  - threat < 0.99: maxInfluence = 6

### Пересчет влияний

Метод `recalculateAllInfluences()` пересчитывает threat для всех гексов:
1. Находит все NPC станции
2. Находит все колонии игроков
3. Для каждого гекса вычисляет влияние от всех источников
4. Берет **максимальное** значение threat

## Колонизация систем

### Метод `colonizeSystem(coordinates, playerId)`

Позволяет игроку колонизировать систему.

**Условия колонизации:**
1. Система существует
2. Система не колонизирована другим игроком
3. Система не является NPC станцией
4. Система не под сильным влиянием других систем (threat <= 0)

**Результат колонизации:**
- `systemType` устанавливается в `PLANETARY`
- `owner` устанавливается в `playerId`
- `hasStation` устанавливается в `true`
- `threat` устанавливается в `0.5`
- `lastDecayCheck` инициализируется текущим временем
- Пересчитывается влияние на соседние системы

**Возвращает:**
```typescript
{ success: boolean; error?: string }
```

### Метод `developColony(coordinates, playerId)`

Развивает существующую колонию, увеличивая её влияние.

**Условия развития:**
1. Система существует
2. Система принадлежит игроку (`owner === playerId`)
3. Система является колонией (`hasStation === true` и не NPC)

**Результат развития:**
- `threat` увеличивается на `+0.1`
- Максимальный `threat` = `1.0`
- Пересчитывается влияние на соседние системы

**Возвращает:**
```typescript
{ success: boolean; error?: string }
```

## Деградация колоний

### Метод `checkColonyDecay()`

Проверяет и применяет деградацию колоний каждые 5 минут.

**Условия деградации:**
1. Прошло минимум 5 минут с последней проверки
2. В радиусе 5 гексов есть опасные зоны (threat < -0.5)

**Результат деградации:**
- `threat` уменьшается на `-0.1`
- Минимальный `threat` = `0.1`
- Пересчитывается влияние на соседние системы

**Логирование:**
- Инициализация проверки для новой колонии
- Статус каждую минуту до истечения интервала
- Результат проверки (деградация или безопасность)

### Метод `checkNearbyDanger(coordinates)`

Проверяет наличие опасных зон рядом с колонией.

**Параметры:**
- `coordinates` - координаты колонии
- `radius` - радиус проверки (5 гексов)

**Возвращает:**
- `true` - если найдены опасные зоны (threat < -0.5)
- `false` - если колония в безопасности

## Другие методы

### `getCell(coordinates): HexCell | undefined`
Получает информацию о гексе по координатам.

### `discoverCell(coordinates, playerId): void`
Отмечает гекс как открытый игроком (добавляет в `discoveredBy`).

### `getMap(): HexMap`
Возвращает полную карту со всеми гексами.

## Примеры использования

### Колонизация системы

```typescript
const hexMap = new HexMapManager(10);

// Игрок пытается колонизировать систему
const result = hexMap.colonizeSystem({ q: 5, r: 3 }, 'player-123');

if (result.success) {
  console.log('Система успешно колонизирована!');
} else {
  console.error('Ошибка:', result.error);
}
```

### Развитие колонии

```typescript
// Развить колонию до максимального уровня
let result;
do {
  result = hexMap.developColony({ q: 5, r: 3 }, 'player-123');
  if (result.success) {
    const cell = hexMap.getCell({ q: 5, r: 3 });
    console.log(`Threat колонии: ${cell?.threat}`);
  }
} while (result.success && cell?.threat < 1.0);
```

### Проверка threat гекса

```typescript
const cell = hexMap.getCell({ q: 3, r: 2 });

if (cell) {
  if (cell.threat > 0) {
    console.log('Безопасная зона');
  } else if (cell.threat < -0.5) {
    console.log('Опасная зона!');
  } else {
    console.log('Нейтральная зона');
  }
}
```

## Интеграция с GameWorld

`HexMapManager` интегрирован в `GameWorld`:
- Автоматическая проверка деградации каждые 10 секунд
- Сохранение карты в БД при изменениях
- Синхронизация с клиентами через Socket.io

## Визуализация на клиенте

Threat отображается на карте через цветовую схему:
- Зеленый - безопасные зоны (threat > 0)
- Желтый - нейтральные зоны (threat ≈ 0)
- Красный - опасные зоны (threat < 0)

## Планы развития

- [ ] Различные типы колоний с уникальными бонусами
- [ ] Торговые маршруты между колониями
- [ ] Система ресурсов для развития колоний
- [ ] Боевые действия за контроль колоний
- [ ] Дипломатия между игроками
